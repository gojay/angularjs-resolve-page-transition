<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Promise</title>
	<script src="jquery.js"></script>
	<script>
		var url = 'http://dev.angularjs/_learn_/angularjs-resolve-page-transition/api';
		// $(document).ready(function(){

		// 	var url = 'http://dev.angularjs/_learn_/angularjs-resolve-page-transition/api';
		// 	var promises = [
		// 	    $.getJSON(url + '/promise/1'),
		// 	    $.getJSON(url + '/promise/2'),
		// 	    $.getJSON(url + '/promise/3'),
		// 	    $.getJSON(url + '/promise/4'),
		// 	    $.getJSON(url + '/promise/5')
		// 	];
			 
		// 	/*$.when.apply($, promises).done(function(e) {
		// 	    console.debug('debug',e);
		// 	    console.info(arguments);
		// 	});*/

		// 	function intervalPromise(millis, count) {
		// 	    var deferred = $.Deferred();
		// 	    if(count <= 0) {
		// 	        deferred.reject("Negative repeat count " + count);
		// 	    }
		// 	    var iteration = 0;
		// 	    var id = setInterval(function() {
		// 	        deferred.notify(++iteration, count);
		// 	        if(iteration >= count) {
		// 	            clearInterval(id);
		// 	            deferred.resolve();
		// 	        }
		// 	    }, millis);
		// 	    return deferred.promise();
		// 	}

		// 	/*var notifyingPromise = intervalPromise(500, 4);
 
		// 	notifyingPromise.
		// 	    progress(function(iteration, total) {
		// 	        console.debug("Completed ", iteration, "of", total);
		// 	    }).
		// 	    done(function() {
		// 	        console.info("Done");
		// 	    }).
		// 	    fail(function(e) {
		// 	        console.warn(e);
		// 	    });*/
			
		// 	var get = function( url, callback ){
		// 		$.getJSON(url, function(res){
		// 			callback(res);
		// 		});
		// 	};
		// 	function doubleAjax(promises) {
		//     	var deferred = $.Deferred();
		//     	for(v in promises){
		//     		var url = promises[v];
		//     		if(v >= promises.length){
		//     			deferred.resolve(res);
		//     		} else {
		//     			get(url, function(res){
		//     				deferred.notify(res);
		//     			});
		//     		}
		//     	}
		// 	    /*$.getJSON(url +'/promise/1', function(res){
		// 	     	deferred.notify(res);
		// 	     	$.getJSON(url +'/promise/2', function(res){
		// 		     	deferred.notify(res);
		// 		     	$.getJSON(url +'/promise/3', function(res){
		// 			     	deferred.notify(res);
		// 			     	$.getJSON(url +'/promise/4', function(res){
		// 				     	deferred.notify(res);
		// 				     	$.getJSON(url +'/promise/5', function(res){
		// 					     	deferred.resolve(res);
		// 					     })
		// 				     })
		// 			     })
		// 		    })
		// 	    })*/
		// 	    return deferred.promise();
		// 	}

		// 	var promises = [
		// 	    url +'/promise/1',
		// 	    url +'/promise/2',
		// 	    url +'/promise/3',
		// 	    url +'/promise/4',
		// 	    url +'/promise/5'
		// 	];
		// 	doubleAjax(promises).
		// 	    progress(function(threeSquare) {
		// 	        console.info("In the middle", threeSquare);
		// 	    }).
		// 	    done(function(fiveSquare) {
		// 	        console.info("Done", fiveSquare);
		// 	    });
		// })

		// main();

		function main(){
		  $.when(a()).done(function(){
		      logProgress('all completed');
		      console.log('all completed');
		  });
		}

		function a() {
		  var def = $.Deferred( );
		  logProgress('a called');
		  $.ajax(url + '/promise/1').pipe(function(data){
		    var requests = [];
		    for (var i = 0; i < 5; i++) {
		      logProgress('calling b');
		      requests.push( b() );
		    }
		    $.when.apply( $, requests ).then(function() { def.resolve( ); } );
		  });
		  return def.promise();
		}

		// called by a()
		function b() {
		  var def = $.Deferred( ), requests= [];
		  for (var i = 0; i < 5; i++) {
		    requests.push($.ajax(url + '/promise/2', function(data){
		      // do something
		        logProgress('b called');
		        console.log('b called');
		    }));
		  }
		  $.when.apply( $, requests ).then( function() { def.resolve(); } );
		  return def.promise();
		}


		// function logProgress(message){
		// 	$('#progress').append('<li>'+message+'</li>');
		// }

		// Makes sequential getJSON requests, passing the processed results from the 
		// previous request to the next request. seedData is optional.
		// var chainedGetJSON = function(requests, seedData) {
		//   var seed = $.Deferred(),
		//       finalPromise;

		//    	console.log('requests', requests);

		//   finalPromise = requests.reduce(function(promise, request) {
		//       console.log('<<<<<<<<<<<<<<<<<<');
		//       console.log('promise', promise);
		//       console.log('request', request);
		//       console.log('>>>>>>>>>>>>>>>>>>>');
		//     return promise.pipe(function(input) {
		//       console.log('input', input);
		//       return $.getJSON(request.url(input)).pipe(function(json) {
		//         return request.process(json, input);
		//       });
		//     });
		//   }, seed.promise());

		//   	// Start the chain 
		//   	seed.resolve(seedData);

		//   	seed.progress(function(threeSquare) {
	 //        	console.info("In the middle", threeSquare);
	 //    	});

		//   return finalPromise;
		// };

		// var thesaurusUrlForLastWord = function(words) {
		//   var word = words[words.length - 1];
		//   console.log('words', words);
		//   var url = "http://words.bighugelabs.com/api/2/2f0691be609ef56b97d1f8d5261c8bf3/" + word + "/json?callback=?";
		//   console.log('url', url);
		//   return url;
		// };

		// Make three sequential requests to the thesaurus API starting with the word "food". 
		// Each subsequent request will do a new query using the last word returned from the previous result set
		// chainedGetJSON([
		//   { 
		//     url: thesaurusUrlForLastWord,
		//     process: function(json, words) {
		//       // Return synonyms
		//       console.log('synonyms', json, words);
		//       console.log('----------------------------------------------------------------------------');
		//       $.each(words, function(i,e){ logProgress(e) });
		//       return json.noun.syn;
		//     }
		//   },
		//   {
		//     url: thesaurusUrlForLastWord,
		//     process: function(json, words) {
		//       // Add new synonyms to the end
		//       console.log('synonyms to the end', json, words.concat(json.noun.syn));
		//       console.log('----------------------------------------------------------------------------');
		//       $.each(words, function(i,e){ logProgress(e) });
		//       return words.concat(json.noun.syn);
		//     }
		//   },
		//   {
		//     url: thesaurusUrlForLastWord,
		//     process: function(json, words) {
		//       // Add the first three synonyms to the beginning
		//       console.log('the first three synonyms to the beginning', json, json.noun.syn.slice(0,3).concat(words));
		//       console.log('----------------------------------------------------------------------------');
		//       $.each(words, function(i,e){ logProgress(e) });
		//       return json.noun.syn.slice(0,3).concat(words);
		//     }
		//   }
		// ], ["food"]).then(function(words) {
		//     console.log('output', words);
		//   	$('#output').text(words.join("\n"));
		// }).done(function(words){
		//     console.log('complete', words);
		// 	alert('complete');
		// });


		// http://stackoverflow.com/questions/8049041/chaining-ajax-requests-with-jquerys-deferred
		// http://spin.atomicobject.com/2011/08/24/chaining-jquery-ajax-calls/
		// 
		function logProgress(index, message){
			$('.progress').append('<li id="'+index+'">'+message+'</li>');
		}

		var chainedGetJSON2 = function(requests) {
		  	var seed = $.Deferred();

		   	console.log('requests', requests);

		  	var finalPromise = requests.reduce(function(promise, request, index) {
		      	console.log('<<<<<<<<<<<<<<<<<<');
		      	console.log('request', request);
		      	console.log('index', index);
		      	console.log('>>>>>>>>>>>>>>>>>>>');
		    	return promise.pipe(function() {
		    		var liIndex = 'item-' + index;
	        		logProgress(liIndex, 'requesting ' + request);
		      		return $.getJSON(request).pipe(function(res) {
		        		$('.progress #'+liIndex).html('finished ' + JSON.stringify(res));
		        		return res;		        		
		      		});
		    	});
		  	}, seed.promise());

		  	// Start the chain 
		  	seed.resolve();

		  	return finalPromise;
		};

		$.getJSON(url +'/promises').then(function(urls) {
		  	chainedGetJSON2(urls).done(function(res) {
			  	$('#complete').text('All completed');
			})
		});

		// https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/Array/Reduce

		/*[0,1,2,3,4].reduce(function(previousValue, currentValue, index, array){
			console.log('previousValue',previousValue);
			console.log('currentValue',currentValue);
			console.log('index',index);
			console.log('array',array);
		  return previousValue + currentValue;
		}, 20);*/

		/*var flattened = [[0, 1], [2, 3], [4, 5]].reduce(function(a, b) {
			console.log('previousValue',a);
			console.log('currentValue',b);
		    return a.concat(b);
		});*/
	</script>
</head>
<body>
	<ol class="progress"></ol>
	<div id="complete"></div>
</body>
</html>